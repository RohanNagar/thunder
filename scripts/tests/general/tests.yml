config:
  target: "http://localhost:8080"
  plugins:
    expect: {}
  phases:
    - duration: 1
      arrivalRate: 1
      name: General Test
  variables:
    testMetrics: true # Set to false to skip the metrics test

scenarios:
  - name: General
    flow:
      # POST /users
      - log: "Checking for BAD REQUEST when creating a null user..."
      - post:
          url: '/users'
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Cannot post a null user."

      - log: "\nChecking for BAD REQUEST when creating a user with a null email..."
      - post:
          url: '/users'
          auth:
            user: application
            pass: secret
          json:
            email:
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Cannot post a user without an email address."

      - log: "\nChecking for BAD REQUEST when creating a user with an invalid email..."
      - post:
          url: '/users'
          auth:
            user: application
            pass: secret
          json:
            email:
              address: invalidEmail
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Invalid email address format. Please try again."

      - log: "\nChecking for BAD REQUEST when creating a user with invalid properties..."
      - post:
          url: '/users'
          auth:
            user: application
            pass: secret
          json:
            email:
              address: test@test.com
            password: test
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Cannot post a user with invalid properties."

      # Create
      - log: "\nAttempting to create a new user..."
      - post:
          url: '/users'
          auth:
            user: application
            pass: secret
          json:
            email:
              address: success@simulator.amazonses.com
            password: 5f4dcc3b5aa765d61d8327deb882cf99
            uniqueID: ABC123
            attributes:
              - hello
              - world
          capture:
            json: $.email.address
            as: email
          expect:
            - statusCode: 201
            - hasProperty: creationTime
            - hasProperty: lastUpdateTime
            - equals:
                - "{{ email }}"
                - "success@simulator.amazonses.com"

      - log: "\nChecking for CONFLICT when creating a duplicate user..."
      - post:
          url: '/users'
          auth:
            user: application
            pass: secret
          json:
            email:
              address: success@simulator.amazonses.com
            password: 5f4dcc3b5aa765d61d8327deb882cf99
            uniqueID: ABC123
            attributes:
              - hello
              - world
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 409
            - equals:
                - "{{ errorString }}"
                - "User success@simulator.amazonses.com already exists in the database."

      # GET /users
      - log: "\nChecking for BAD REQUEST when getting a user using a null email..."
      - get:
          url: '/users'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing email query parameter."

      - log: "\nChecking for BAD REQUEST when getting a user using an empty email..."
      - get:
          url: '/users?email='
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing email query parameter."

      - log: "\nChecking for BAD REQUEST when getting a user using a null password..."
      - get:
          url: '/users?email=success@simulator.amazonses.com'
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Credentials are required to access this resource."

      - log: "\nChecking for BAD REQUEST when getting a user using an empty password..."
      - get:
          url: '/users?email=success@simulator.amazonses.com'
          headers:
            password: ''
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Credentials are required to access this resource."

      - log: "\nChecking for NOT FOUND when getting a nonexistant user..."
      - get:
          url: '/users?email=test@test.com'
          headers:
            password: password
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 404
            - equals:
                - "{{ errorString }}"
                - "User test@test.com not found in the database."

      - log: "\nChecking for UNAUTHORIZED when getting a user using an incorrect password..."
      - get:
          url: '/users?email=success@simulator.amazonses.com'
          headers:
            password: incorrectPassword
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 401
            - equals:
                - "{{ errorString }}"
                - "Unable to validate user with provided credentials."

      - log: "\nAttempting to get the user..."
      - get:
          url: '/users?email=success@simulator.amazonses.com'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            json: $.email.address
            as: email
          expect:
            - statusCode: 200
            - hasProperty: creationTime
            - hasProperty: lastUpdateTime
            - equals:
                - "{{ email }}"
                - "success@simulator.amazonses.com"

      - log: "\nAttempting to get the user with a common password mistake..."
      - get:
          url: '/users?email=success@simulator.amazonses.com'
          headers:
            password: -5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            json: $.email.address
            as: email
          expect:
            - statusCode: 200
            - hasProperty: creationTime
            - hasProperty: lastUpdateTime
            - equals:
                - "{{ email }}"
                - "success@simulator.amazonses.com"

      # POST /verify
      - log: "\nChecking for BAD REQUEST when sending a verification email to a null email..."
      - post:
          url: '/verify'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing email query parameter."

      - log: "\nChecking for BAD REQUEST when sending a verification email to an empty email..."
      - post:
          url: '/verify?email='
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing email query parameter."

      - log: "\nChecking for BAD REQUEST when sending a verification email with a null password..."
      - post:
          url: '/verify?email=success@simulator.amazonses.com'
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Credentials are required to access this resource."

      - log: "\nChecking for BAD REQUEST when sending a verification email with an empty password..."
      - post:
          url: '/verify?email=success@simulator.amazonses.com'
          headers:
            password: ''
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Credentials are required to access this resource."

      - log: "\nChecking for NOT FOUND when sending an email to a nonexistant user..."
      - post:
          url: '/verify?email=test@test.com'
          headers:
            password: password
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 404
            - equals:
                - "{{ errorString }}"
                - "User test@test.com not found in the database."

      - log: "\nChecking for UNAUTHORIZED when sending a verification email with an incorrect password..."
      - post:
          url: '/verify?email=success@simulator.amazonses.com'
          headers:
            password: incorrectPassword
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 401
            - equals:
                - "{{ errorString }}"
                - "Unable to validate user with provided credentials."

      - log: "\nAttempting to send a verification email..."
      - post:
          url: '/verify?email=success@simulator.amazonses.com'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            - json: $.email.address
              as: email
            - json: $.email.verificationToken
              as: verificationToken
          expect:
            - statusCode: 200
            - hasProperty: creationTime
            - hasProperty: lastUpdateTime
            - equals:
                - "{{ email }}"
                - "success@simulator.amazonses.com"

      # GET /verify
      - log: "\nChecking for BAD REQUEST when verifying with a null email..."
      - get:
          url: '/verify?token={{ verificationToken }}'
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing email query parameter."

      - log: "\nChecking for BAD REQUEST when verifying with an empty email..."
      - get:
          url: '/verify?email=&token={{ verificationToken }}'
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing email query parameter."

      - log: "\nChecking for BAD REQUEST when verifying with a null token..."
      - get:
          url: '/verify?email=success@simulator.amazonses.com'
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing verification token query parameter."

      - log: "\nChecking for BAD REQUEST when verifying with an empty token..."
      - get:
          url: '/verify?email=success@simulator.amazonses.com&token='
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing verification token query parameter."

      - log: "\nChecking for BAD REQUEST when verifying with an incorrect token..."
      - get:
          url: '/verify?email=success@simulator.amazonses.com&token=incorrectToken'
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect verification token."

      - log: "\nAttempting to verify the user..."
      - get:
          url: '/verify?email=success@simulator.amazonses.com&token={{ verificationToken }}'
          auth:
            user: application
            pass: secret
          capture:
            - json: $.email.address
              as: email
            - json: $.email.verified
              as: verified
          expect:
            - statusCode: 200
            - hasProperty: creationTime
            - hasProperty: lastUpdateTime
            - equals:
                - "{{ email }}"
                - "success@simulator.amazonses.com"
            - equals:
                - "{{ verified }}"
                - true

      - log: "\nAttempting to verify the user and get HTML..."
      - get:
          url: '/verify?email=success@simulator.amazonses.com&token={{ verificationToken }}&response_type=html'
          auth:
            user: application
            pass: secret
          expect:
            - statusCode: 200
            # TODO: verify HTML is as expected

      # POST /verify/reset
      - log: "\nChecking for BAD REQUEST when resetting user verification with a null email..."
      - post:
          url: '/verify/reset'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing email query parameter."

      - log: "\nChecking for BAD REQUEST when resetting user verification with an empty email..."
      - post:
          url: '/verify/reset?email='
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing email query parameter."

      - log: "\nChecking for BAD REQUEST when resetting user verification with a null password..."
      - post:
          url: '/verify/reset?email=success@simulator.amazonses.com'
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Credentials are required to access this resource."

      - log: "\nChecking for BAD REQUEST when resetting user verification with an empty password..."
      - post:
          url: '/verify/reset?email=success@simulator.amazonses.com'
          headers:
            password: ''
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Credentials are required to access this resource."

      - log: "\nChecking for NOT FOUND when resetting verification for a nonexistant user..."
      - post:
          url: '/verify/reset?email=test@test.com'
          headers:
            password: test
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 404
            - equals:
                - "{{ errorString }}"
                - "User test@test.com not found in the database."

      - log: "\nChecking for UNAUTHORIZED when resetting user verification with an incorrect password..."
      - post:
          url: '/verify/reset?email=success@simulator.amazonses.com'
          headers:
            password: incorrectPassword
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 401
            - equals:
                - "{{ errorString }}"
                - "Unable to validate user with provided credentials."

      - log: "\nAttempting to reset the user verification status..."
      - post:
          url: '/verify/reset?email=success@simulator.amazonses.com'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            - json: $.email.address
              as: email
            - json: $.email.verified
              as: verified
          expect:
            - statusCode: 200
            - hasProperty: creationTime
            - hasProperty: lastUpdateTime
            - equals:
                - "{{ email }}"
                - "success@simulator.amazonses.com"
            - equals:
                - "{{ verified }}"
                - false

      - log: "\nAttempting to send another verification email..."
      - post:
          url: '/verify?email=success@simulator.amazonses.com'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            - json: $.email.address
              as: email
            - json: $.email.verificationToken
              as: verificationToken
            - json: $.email.verified
              as: verified
          expect:
            - statusCode: 200
            - hasProperty: creationTime
            - hasProperty: lastUpdateTime
            - equals:
                - "{{ email }}"
                - "success@simulator.amazonses.com"
            - equals:
                - "{{ verified }}"
                - false

      - log: "\nAttempting to re-verify the user..."
      - get:
          url: '/verify?email=success@simulator.amazonses.com&token={{ verificationToken }}'
          auth:
            user: application
            pass: secret
          capture:
            - json: $.email.address
              as: email
            - json: $.email.verified
              as: verified
          expect:
            - statusCode: 200
            - hasProperty: creationTime
            - hasProperty: lastUpdateTime
            - equals:
                - "{{ email }}"
                - "success@simulator.amazonses.com"
            - equals:
                - "{{ verified }}"
                - true

      # PUT /users
      - log: "\nChecking for BAD REQUEST when updating a user with a null password..."
      - put:
          url: '/users'
          auth:
            user: application
            pass: secret
          json:
            email:
              address: success@simulator.amazonses.com
            password: 5f4dcc3b5aa765d61d8327deb882cf99
            uniqueID: ABC123
            attributes:
              - hello
              - world
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Credentials are required to access this resource."

      - log: "\nChecking for BAD REQUEST when updating a user with an empty password..."
      - put:
          url: '/users'
          headers:
            password: ''
          auth:
            user: application
            pass: secret
          json:
            email:
              address: success@simulator.amazonses.com
            password: 5f4dcc3b5aa765d61d8327deb882cf99
            uniqueID: ABC123
            attributes:
              - hello
              - world
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Credentials are required to access this resource."

      - log: "\nChecking for BAD REQUEST when updating a null user..."
      - put:
          url: '/users'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Cannot post a null user."

      - log: "\nChecking for BAD REQUEST when updating a user with a null email..."
      - put:
          url: '/users'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          json:
            email:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
            uniqueID: ABC123
            attributes:
              - hello
              - world
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Cannot post a user without an email address."

      - log: "\nChecking for BAD REQUEST when updating a user with an invalid email..."
      - put:
          url: '/users'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          json:
            email:
              address: invalidEmail
            password: 5f4dcc3b5aa765d61d8327deb882cf99
            uniqueID: ABC123
            attributes:
              - hello
              - world
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Invalid email address format. Please try again."

      - log: "\nChecking for BAD REQUEST when updating a user with invalid properties..."
      - put:
          url: '/users'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          json:
            email:
              address: success@simulator.amazonses.com
            password: 5f4dcc3b5aa765d61d8327deb882cf99
            uniqueID: ABC123
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Cannot post a user with invalid properties."

      - log: "\nChecking for NOT FOUND when updating a nonexistant user..."
      - put:
          url: '/users?email=test@test.com'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          json:
            email:
              address: success@simulator.amazonses.com
            password: 5f4dcc3b5aa765d61d8327deb882cf99
            uniqueID: ABC123
            attributes:
              - hello
              - world
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 404
            - equals:
                - "{{ errorString }}"
                - "User test@test.com not found in the database."

      - log: "\nChecking for NOT FOUND when updating a nonexistant user..."
      - put:
          url: '/users'
          headers:
            password: incorrectPassword
          auth:
            user: application
            pass: secret
          json:
            email:
              address: success@simulator.amazonses.com
            password: 5f4dcc3b5aa765d61d8327deb882cf99
            uniqueID: ABC123
            attributes:
              - hello
              - world
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 401
            - equals:
                - "{{ errorString }}"
                - "Unable to validate user with provided credentials."

      - log: "\nAttempting to update the unique ID property..."
      - put:
          url: '/users'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          json:
            email:
              address: success@simulator.amazonses.com
              verified: true
              verificationToken: shouldNotBeWritten
            password: 5f4dcc3b5aa765d61d8327deb882cf99
            uniqueID: NEW_ID
            attributes:
              - hello
              - world
          capture:
            - json: $.email.verified
              as: verified
            - json: $.uniqueID
              as: uniqueID
            - json: $.email.verificationToken
              as: updatedVerificationToken
          expect:
            - statusCode: 200
            - equals:
                - "{{ verified }}"
                - true
            - equals:
                - "{{ uniqueID }}"
                - NEW_ID
            - equals:
                - "{{ updatedVerificationToken }}"
                - "{{ verificationToken }}"

      - log: "\nAttempting to update the email..."
      - put:
          url: '/users?email=success@simulator.amazonses.com'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          json:
            email:
              address: newemail@gmail.com
              verified: true
              verificationToken: shouldNotBeWritten
            password: 5f4dcc3b5aa765d61d8327deb882cf99
            uniqueID: NEW_ID
            attributes:
              - hello
              - world
          capture:
            - json: $.email.verified
              as: verified
            - json: $.email.address
              as: email
            - json: $.email.verificationToken
              as: updatedVerificationToken
          expect:
            - statusCode: 200
            - equals:
                - "{{ verified }}"
                - false
            - equals:
                - "{{ email }}"
                - "newemail@gmail.com"
            - equals:
                - "{{ updatedVerificationToken }}"
                - ""

      # DELETE /users
      - log: "\nChecking for BAD REQUEST when deleting a user with a null email..."
      - delete:
          url: '/users'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing email query parameter."

      - log: "\nChecking for BAD REQUEST when deleting a user with an empty email..."
      - delete:
          url: '/users?email='
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Incorrect or missing email query parameter."

      - log: "\nChecking for BAD REQUEST when deleting a user with a null password..."
      - delete:
          url: '/users?email=newemail@gmail.com'
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Credentials are required to access this resource."

      - log: "\nChecking for BAD REQUEST when deleting a user with an empty password..."
      - delete:
          url: '/users?email=newemail@gmail.com'
          headers:
            password: ''
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 400
            - equals:
                - "{{ errorString }}"
                - "Credentials are required to access this resource."

      - log: "\nChecking for NOT FOUND when deleting a nonexistant user..."
      - delete:
          url: '/users?email=test@test.com'
          headers:
            password: test
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 404
            - equals:
                - "{{ errorString }}"
                - "User test@test.com not found in the database."

      - log: "\nChecking for UNAUTHORIZED when deleting a user with an incorrect password..."
      - delete:
          url: '/users?email=newemail@gmail.com'
          headers:
            password: incorrectPassword
          auth:
            user: application
            pass: secret
          capture:
            regexp: .+
            as: errorString
          expect:
            - statusCode: 401
            - equals:
                - "{{ errorString }}"
                - "Unable to validate user with provided credentials."

      - log: "\nAttempting to delete the user..."
      - delete:
          url: '/users?email=newemail@gmail.com'
          headers:
            password: 5f4dcc3b5aa765d61d8327deb882cf99
          auth:
            user: application
            pass: secret
          capture:
            json: $.email.address
            as: email
          expect:
            - statusCode: 200
            - hasProperty: creationTime
            - hasProperty: lastUpdateTime
            - equals:
                - "{{ email }}"
                - "newemail@gmail.com"

      # /openapi.json
      - log: "\nReading the generated Swagger JSON..."
      - get:
          url: '/openapi.json'
          capture:
            - json: $.info.title
              as: title
            - json: $.info.description
              as: description
          expect:
            - statusCode: 200
            - equals:
                - "{{ title }}"
                - Thunder API
            - equals:
                - "{{ description }}"
                - A fully customizable user management REST API

      # /openapi.yaml
      - log: "\nReading the generated Swagger YAML..."
      - get:
          url: '/openapi.yaml'
          expect:
            - statusCode: 200

      # /swagger
      - log: "\nReading the generated Swagger UI HTML..."
      - get:
          url: '/swagger'
          expect:
            - statusCode: 200

      # ADMIN /metrics
      - log: "\nVerifying metrics were updated correctly?: {{ testMetrics }}"
      - get:
          url: 'http://localhost:8081/metrics'
          ifTrue: "testMetrics"
          capture:
            - json: $.meters["com.sanctionco.thunder.resources.UserResource.delete-requests"].count
              as: deleteRequestCount
            - json: $.meters["com.sanctionco.thunder.resources.UserResource.get-requests"].count
              as: getRequestCount
            - json: $.meters["com.sanctionco.thunder.resources.UserResource.post-requests"].count
              as: postRequestCount
            - json: $.meters["com.sanctionco.thunder.resources.UserResource.update-requests"].count
              as: updateRequestCount
            - json: $.meters["com.sanctionco.thunder.resources.VerificationResource.reset-verification-requests"].count
              as: resetVerificationRequestCount
            - json: $.meters["com.sanctionco.thunder.resources.VerificationResource.send-email-requests"].count
              as: sendEmailRequestCount
            - json: $.meters["com.sanctionco.thunder.resources.VerificationResource.verify-email-requests"].count
              as: verifyEmailRequestCount
            - json: $.meters["com.sanctionco.thunder.openapi.SwaggerResource.swagger-ui-requests"].count
              as: swaggerUIRequestCount
            - json: $.counters["com.sanctionco.thunder.email.EmailService.email-send-success"].count
              as: emailSendSuccessCount
          expect:
            - statusCode: 200
            - equals:
                - "{{ deleteRequestCount }}"
                - 7
            - equals:
                - "{{ getRequestCount }}"
                - 8
            - equals:
                - "{{ postRequestCount }}"
                - 6
            - equals:
                - "{{ updateRequestCount }}"
                - 10
            - equals:
                - "{{ resetVerificationRequestCount }}"
                - 7
            - equals:
                - "{{ sendEmailRequestCount }}"
                - 8
            - equals:
                - "{{ verifyEmailRequestCount }}"
                - 8
            - equals:
                - "{{ swaggerUIRequestCount }}"
                - 1
            - equals:
                - "{{ emailSendSuccessCount }}"
                - 2

      # ADMIN /healthcheck
      - log: "\nVerifying health of the application..."
      - get:
          url: 'http://localhost:8081/healthcheck'
          capture:
            - json: $.Database.healthy
              as: dbHealth
            - json: $.Email.healthy
              as: emailHealth
            - json: $.deadlocks.healthy
              as: deadlockHealth
          expect:
            - statusCode: 200
            - equals:
                - "{{ dbHealth }}"
                - true
            - equals:
                - "{{ emailHealth }}"
                - true
            - equals:
                - "{{ deadlockHealth }}"
                - true
